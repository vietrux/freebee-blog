---
import '../styles/global.css';
import BrutalistLayout from '../layouts/brutalist.astro';
import Marquee from '../components/marquee.astro';
import { getCollection } from 'astro:content';

// Get all blog posts
const allPosts = await getCollection('blog');
const posts = allPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Get featured post
const featuredPost = posts.find(post => post.data.featured) || posts[0];

// Create breaking news from post titles (fallback for new stories)
const breakingNewsFallback = posts.slice(0, 8).map(post => 
	`BREAKING: ${post.data.title}`
);

// Fetch latest Hacker News new stories (for breaking news marquee)
async function getHackerNewsNewStories() {
	try {
		// Get new story IDs
		const response = await fetch('https://hacker-news.firebaseio.com/v0/newstories.json');
		const storyIds = await response.json();
		
		// Get first 8 story details
		const storyPromises = storyIds.slice(0, 8).map(async (id) => {
			const storyResponse = await fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`);
			return await storyResponse.json();
		});
		
		const stories = await Promise.all(storyPromises);
		return stories.filter(story => story && story.title).map(story => `BREAKING: ${story.title}`);
	} catch (error) {
		console.error('Failed to fetch Hacker News new stories:', error);
		// Fallback to blog posts if API fails
		return breakingNewsFallback;
	}
}

// Get Hacker News stories for breaking news marquee
const hackerNewsNewStories = await getHackerNewsNewStories();
---

<BrutalistLayout title="FREEBEE BLOG POSTS">
	<!-- Breaking News Marquee -->
	<div style="background: var(--brutal-black); padding: 0;">
		<Marquee items={hackerNewsNewStories} />
		<div style="text-align: center; padding: 8px 0; background: var(--brutal-black); color: var(--brutal-white); font-size: 0.8rem; font-family: 'Courier Prime', monospace; border-top: 1px solid var(--brutal-border);">
			* This is a breaking news marquee from Hacker News.
		</div>
	</div>

	<!-- Featured Article - Full Width -->
	<div style="width: 100%; background: var(--brutal-white); padding: 0px; border-top: 1px solid var(--brutal-border); border-bottom: 1px solid var(--brutal-border);">
		<div style="max-width: 1200px; margin: 0 auto;">
			<div class={`news-card ${featuredPost.data.color}`} style="padding: 40px; color: var(--brutal-black);">
				<div class="brutal-text" style="font-size: 2.5rem; margin-bottom: 20px;">
					FEATURED: {featuredPost.data.title}
				</div>
				<div style="font-size: 1.3rem; line-height: 1.4; margin-bottom: 20px;">
					{featuredPost.data.excerpt}
				</div>
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
					<div class="author-badge">
						BY {featuredPost.data.author}
					</div>
					<div style="font-weight: 700; text-transform: uppercase;">
						{featuredPost.data.date.toLocaleDateString('en-US', { 
							year: 'numeric', 
							month: 'long', 
							day: 'numeric' 
						})}
					</div>
				</div>
				<a href={`/blog/${featuredPost.slug}`} class="brutal-button" style="font-size: 1.1rem; padding: 5px; text-decoration: none; display: inline-block; background: var(--brutal-red); color: var(--brutal-black); border-color: var(--brutal-red);">
					READ MORE
				</a>
			</div>
		</div>
	</div>

	<!-- Main Content -->
	<div style="padding: 40px 20px; max-width: 1200px; margin: 0 auto;">

		<!-- News Grid -->
		<div class="news-grid">
			{posts.map((post, index) => (
				<>
					<article class={`news-card ${post.data.color}`}>
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
							<div class="brutal-text" style="font-size: 0.9rem; color: var(--brutal-black);">
								{post.data.category}
							</div>
							<div style="font-size: 0.8rem; font-weight: 700;">
								{post.data.date.toLocaleDateString('en-US', { 
									month: 'short', 
									day: 'numeric' 
								})}
							</div>
						</div>
						<h2 class="brutal-text" style="font-size: 1.5rem; margin-bottom: 15px; line-height: 1.2;">
							{post.data.title}
						</h2>
						<p style="font-size: 1rem; line-height: 1.4; margin-bottom: 20px;">
							{post.data.excerpt}
						</p>
						<a href={`/blog/${post.slug}`} class="brutal-button" style=" text-decoration: none; display: inline-block; text-align: center; background: var(--brutal-red); color: var(--brutal-black);">
							READ MORE
						</a>
					</article>
					{index < posts.length - 1 && (
						<div style="width: 100%; height: 2px; background: var(--brutal-border); margin: 20px 0; border-radius: 1px;"></div>
					)}
				</>
			))}
		</div>

		<!-- Call to Action -->
		<div style="text-align: center; margin-top: 60px; padding: 40px; background: var(--brutal-white); color: var(--brutal-black); border: 4px solid var(--brutal-white); box-shadow: 8px 8px 0px var(--brutal-white);">
			<div class="brutal-text" style="font-size: 2rem; margin-bottom: 20px;">
				CONNECT WITH FREEBEE
			</div>
			<div style="font-size: 1.2rem; margin-bottom: 30px;">
				Follow my security journey, CTF writeups, and coding adventures. 
				Let's learn and hack together!
			</div>
			<a href="https://t.me/frogv7" class="brutal-button" style="font-size: 1.1rem; padding: 16px 32px; text-decoration: none; display: inline-block;">
				CONTACT ON TELEGRAM
			</a>
		</div>
	</div>
</BrutalistLayout>
